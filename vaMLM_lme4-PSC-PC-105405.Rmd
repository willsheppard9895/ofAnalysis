---
title: "vaMLM"
author: "Will Sheppard"
date: "2023-08-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

THe aim of this script is to get the best fitting MLM for the visual acuity data by means of AIC comparison, whereby we will compare 4 distributions: Normal, Gamma, Gaussian and Inverse Gausia using the lme4 package. The lmer funciton will be used for the normal and Gamma distributions and the glmer function will be used for the Gausian and inverse gausian distributions.

fixed parameters: visual condition and age
random parameters: Participant id and researcher

Reearcher will be entered as a random effect as each researher used a different laptop, so this may effect the overall outcome and we are interested in modelling this variability but are not strictly interested in this effect with regards our research question.

```{r packages}
library(tidyverse)
library(lme4)
library(lmerTest)
require(car)
require(MASS)

```

```{r read data}

pplist <- read.csv("../cleanData/pplist.csv")%>%
  dplyr::select(-X) %>%
  rename(id = x)

pps <- as.list(pplist$id)

va <- read.csv("../cleanData/vaThresh.csv")%>% 
  rename(VA = threshold) %>%
  filter(Participant.Private.ID %in% pps)

demo <- read.csv("../studentData/studentDemographicsWideEdit.csv")%>%
  filter(Participant.Private.ID %in% pps)


```


To identify the reserarcher, we need to identify the 3 unique combos of OS and monitor size
```{r researcher id}

resDF <- demo %>%
  dplyr::select(Participant.Private.ID, Participant.OS, Participant.Monitor.Size) 

resDF <- na.omit(resDF)
  
resDF <- resDF %>%
  mutate(pcID = paste(Participant.OS, Participant.Monitor.Size)) %>%
  mutate(resID = case_when(
    pcID == "Windows 10 1536x864" ~ 1,
    pcID == "Windows 10 1280x720" ~ 2,
    pcID == "Mac OS 10.15.7 1440x900" ~ 3
  )) %>%
  select(Participant.Private.ID, resID)

```

Create a data frame containing participant id and their age
```{r particiapnt age}

age <- demo %>%
  select(Participant.Private.ID, age_in_years)

```


now we will join the three data frames on Participant id 
revalue condition so that clear is 0 and blur is 1. the coefficient will down us the 'effect' of blur on va
```{r join df}

vaAge <- left_join(va, age)
d <- left_join(vaAge, resDF) %>%
  rename(age = age_in_years)%>%
  mutate(condition = case_when(
    condition == 'clear' ~ 0,
    TRUE ~ 1
  ))


```

Let's plot the visual acuity data
```{r va violin}


vaViolin <- ggplot(d, mapping = aes(x = condition, y = VA)) +
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75)) +
  geom_jitter(height = 0, width = 0.2, alpha = .6, aes(color = age, fill = age))+
  scale_color_gradient(low = "lightgrey",
                        high = "black")+
  scale_fill_gradient(low = "lightgrey",
                        high = "black")+
  scale_x_discrete(labels = c("Monocular blur", "No blur"))+
  theme(#legend.title = element_blank(),
        axis.title.x.bottom = element_blank())+
  labs(color = "Age (years)",
       fill = "Age (years)") 

show(vaViolin)
```

```{r save va plot, eval=FALSE}

dpi = 800
h = 4
w = 7

ggsave('../figures/vaViolin.png',
       plot = vaViolin,
       dpi = dpi,
       width = w,
       height = h)

```

it is worth creating qqplots to get a sense of which distributions best fit my data.
Many distributions cannot handle non-positive numbers, so i will +1 to all va numbers to improve this

Gamma visually have the best fits, so we will push forward with modelling these
data are not normal - Shapiro wilk: W = 0.064, p = .007
when looking at the raw distributions, there is an elongated tail on the va data, so an inverse gausian dist may also be a good fit. Also model this.
```{r distribution comparisons}

ggplot(d, aes(x = VA, group = condition))+geom_density()

d$VA.t <- d$VA+1


qqp(d$VA.t, "norm")

qqp(d$VA.t, "lnorm")


# qqp requires estimates of the parameters of the negative binomial, Poisson
# and gamma distributions. You can generate estimates using the fitdistr
# function. Save the output and extract the estimates



poisson <- fitdistr(d$VA.t, "Poisson")
qqp(d$VA.t, "pois", lambda = poisson$estimate)

gamma <- fitdistr(d$VA.t, "gamma")
qqp(d$VA.t, "gamma", shape = gamma$estimate[[1]], rate = gamma$estimate[[2]])
```

```{r va gamma}

require(MASS)
va <- lm(VA.t ~ condition + age,
         data = d)
summary(va)
vaG <- glmer(VA.t ~ (1|Participant.Private.ID),
                 family = Gamma(link = "identity"),
                   data = d, 
                 glmerControl(optimizer = "Nelder_Mead", optCtrl = list(maxfun = 10000000)))


anova(va, vaG)

vaGamma <- vaGammaCondition <- glmer(VA.t ~ condition + (1|Participant.Private.ID),
                 family = Gamma(link = "identity"),
                   data = d, 
                 glmerControl(optimizer = "Nelder_Mead", optCtrl = list(maxfun = 10000000)))

summary(vaGamma)
Confint(vaGamma)
fixef(vaGamma)


anova(vaG, vaGamma) # vaGamma explains sig more variance, add age

summary(vaGammaCondition)
d$condition.t <- d$condition + 1

vaGammaAge <- vaGammaCondition <- glmer(VA.t ~ condition + age + (1|Participant.Private.ID),
                 family = Gamma(link = "identity"),
                   data = d, 
                 glmerControl(optimizer = "Nelder_Mead", optCtrl = list(maxfun = 10000000)))

anova(vaGamma, vaGammaAge) # age not sig (increases AIC), remove. Add random slope for condition within partiicpant


vaGammaCondition <- glmer(VA.t ~ condition.t + (condition.t|Participant.Private.ID),
                 family = Gamma(link = "identity"),
                   data = d, 
                 glmerControl(optimizer = "Nelder_Mead", optCtrl = list(maxfun = 10000000)))
Confint(vaGammaCondition)

summary(vaGammaCondition)

anova(vaGamma, vaGammaCondition) # significantly better fit. Add random intercept for researcher


vaGammaConditionRes <- glmer(VA.t ~ condition + (1|resID) + (condition|Participant.Private.ID),
                 family = Gamma(link = "identity"),
                   data = d, 
                 glmerControl(optimizer = "Nelder_Mead", optCtrl = list(maxfun = 10000000))
                 )


anova(vaGammaCondition, vaGammaConditionRes) # sig better fit without extra parameter. Make vaGammaCondition the final model

vaGammaFinal <- glmer(VA.t ~ condition + (condition|Participant.Private.ID),
                 family = Gamma(link = "identity"),
                   data = d, 
                 glmerControl(optimizer = "Nelder_Mead")
                 )


summary(vaGammaFinal)

fixef(vaGammaFinal)
coef(summary(vaGammaFinal))
con(vaGammaFinal)

Confint(vaGammaFinal)
```

```{r change plot}

ggplot(d, mapping = aes(x = condition, y = VA)) +
  geom_point() +
  geom_line(aes(group = Participant.Private.ID))

ggsave

```
maybe iu don't have enough data to fit these models.

let's simulate some. let's say we had 100 times more data
```{r sim data}


pps <- unique(d$Participant.Private.ID)

simData <- data.frame(matrix(
  nrow = length(pps)*10,
  ncol = 3
))

colnames(simData) <- c("id", "simCondition", "simVA.t")

simCondition <- NULL
simVA.t <- NULL

simConditionLong <- NULL
simVA.tLong <- NULL

listLong <- NULL

for (pp in pps) {
  data <- d %>%
    filter(Participant.Private.ID == pp)
  n <- 10
  m <- mean(data$VA.t)
  sd <- sd(data$VA.t)
  
  simVA.t <- sort(rnorm(n, mean = m, sd = sd))
  
  
  # finds whihc condition the participant performed worse at
  worseCond <- data[which.max(data$VA.t), 2]
  
  if (worseCond == 0){
    betterCond <- 1
  }else{
    betterCond <- 0
  }
  
  better <- rep(betterCond, each = n/2)
  worse <- rep(worseCond, each = n/2)
  simCondition <- c(better, worse)
  
  simConditionLong <- c(simConditionLong, simCondition)
  simVA.tLong <- c(simVA.tLong, simVA.t)
  
  

}

simData$simCondition <- simConditionLong
simData$simVA.t <- simVA.tLong

a <- seq(from = 1, to = 256, by = 5)
b <- seq(from = 5, to = 260, by = 5)
c <- 1:length(a)

for (ind in c) {
  
  e <- a[ind]
   
  f <- b[ind]
  
  list <- rep(e:f, times = 2)
  listLong <- c(listLong, list)
}

rep(1:5, length.out = 520)
simData$id <- listLong



simData %>%
  dplyr::group_by(simCondition)%>%
  dplyr::summarise(mean(simVA.t))
```


let's play with the sim data
```{r sim play}

ggplot(simData, aes(x = simVA.t, group = simCondition, color = simCondition))+
  geom_density()

simVaGammaCondition <- glmer(simVA.t ~ simCondition + (1|id),
                             family = Gamma(link = "identity"),
                              data = simData, 
                              glmerControl(optimizer = "Nelder_Mead", optCtrl = list(maxfun = 10000000)))
summary(simVaGammaCondition)

Confint(vaGammaCondition)

```